# spring概述
![image.png](https://cdn.nlark.com/yuque/0/2022/png/26091703/1662191499311-271aa7b3-9aaa-4960-a3a4-c11c03012f4b.png#averageHue=%23f4f4f4&clientId=u8c29d1e2-1fcd-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=609&id=u73f041b2&margin=%5Bobject%20Object%5D&name=image.png&originHeight=761&originWidth=600&originalType=binary&ratio=1&rotation=0&showTitle=false&size=136177&status=done&style=none&taskId=u2eabd6aa-7f23-467b-8d51-1122abab8e5&title=&width=480)
![image.png](https://cdn.nlark.com/yuque/0/2022/png/26091703/1662192493934-8155da3a-f556-41c5-8b29-b39903e2e804.png#averageHue=%23f4f4f4&clientId=u8c29d1e2-1fcd-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=715&id=ubf891ceb&margin=%5Bobject%20Object%5D&name=image.png&originHeight=894&originWidth=1131&originalType=binary&ratio=1&rotation=0&showTitle=false&size=283766&status=done&style=none&taskId=u52a46731-0978-447d-9703-e4896f7eafa&title=&width=904.8)![image.png](https://cdn.nlark.com/yuque/0/2022/png/26091703/1662192736848-98820903-edcf-4ba8-8ceb-4608998799b5.png#averageHue=%23f2f2f2&clientId=u8c29d1e2-1fcd-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=657&id=u0de8a554&margin=%5Bobject%20Object%5D&name=image.png&originHeight=821&originWidth=898&originalType=binary&ratio=1&rotation=0&showTitle=false&size=269434&status=done&style=none&taskId=u023f0803-0beb-4b40-a262-e697cb101e3&title=&width=718.4)![image.png](https://cdn.nlark.com/yuque/0/2022/png/26091703/1662192746431-c25f40fc-360c-4332-aaa1-458ae3c20b20.png#averageHue=%23efefef&clientId=u8c29d1e2-1fcd-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=629&id=u5862843a&margin=%5Bobject%20Object%5D&name=image.png&originHeight=786&originWidth=910&originalType=binary&ratio=1&rotation=0&showTitle=false&size=139046&status=done&style=none&taskId=u356b6184-28c0-4b85-b964-090f0da2ed4&title=&width=728)![image.png](https://cdn.nlark.com/yuque/0/2022/png/26091703/1662192853627-0f852352-f623-4b50-b909-f68b26e28ce8.png#averageHue=%23f0f0f0&clientId=u8c29d1e2-1fcd-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=442&id=u69b32f52&margin=%5Bobject%20Object%5D&name=image.png&originHeight=552&originWidth=933&originalType=binary&ratio=1&rotation=0&showTitle=false&size=237453&status=done&style=none&taskId=u0b99f9ec-a5ce-407a-ba82-1b07a695064&title=&width=746.4)![image.png](https://cdn.nlark.com/yuque/0/2022/png/26091703/1662192862915-0a11780f-e89f-4f69-bc43-145c80064883.png#averageHue=%23f2f1f1&clientId=u8c29d1e2-1fcd-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=600&id=u917fea59&margin=%5Bobject%20Object%5D&name=image.png&originHeight=750&originWidth=902&originalType=binary&ratio=1&rotation=0&showTitle=false&size=193876&status=done&style=none&taskId=u53881636-abd9-4453-86ce-a76e87bf129&title=&width=721.6)![image.png](https://cdn.nlark.com/yuque/0/2022/png/26091703/1662192908847-914adcf3-9550-48e4-b5ec-dcca0a586399.png#averageHue=%23f4f4f4&clientId=u8c29d1e2-1fcd-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=107&id=ub6b0c64e&margin=%5Bobject%20Object%5D&name=image.png&originHeight=112&originWidth=149&originalType=binary&ratio=1&rotation=0&showTitle=false&size=7310&status=done&style=none&taskId=ufa519b1b-f21d-486a-b9d6-0298a244331&title=&width=142.20000457763672)
# ioc核心思想
![image.png](https://cdn.nlark.com/yuque/0/2022/png/26091703/1662193451734-26ab8ab1-b2ba-4e32-abeb-8b63cfb963a4.png#averageHue=%23f4f4f4&clientId=u8c29d1e2-1fcd-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=455&id=u0ce6cada&margin=%5Bobject%20Object%5D&name=image.png&originHeight=569&originWidth=873&originalType=binary&ratio=1&rotation=0&showTitle=false&size=166525&status=done&style=none&taskId=u3af84a26-69ac-4dba-a0f8-f4388956c2f&title=&width=698.4)![image.png](https://cdn.nlark.com/yuque/0/2022/png/26091703/1662193465747-62e29bc0-1c38-4ee5-922e-9dd6137e4446.png#averageHue=%23f9f9f9&clientId=u8c29d1e2-1fcd-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=692&id=u452b8e49&margin=%5Bobject%20Object%5D&name=image.png&originHeight=865&originWidth=1085&originalType=binary&ratio=1&rotation=0&showTitle=false&size=125113&status=done&style=none&taskId=ue9ac2abb-95a5-475b-bfee-1fa03f670ea&title=&width=868)![image.png](https://cdn.nlark.com/yuque/0/2022/png/26091703/1662194573808-a3a787c9-f0e3-4f49-86ed-170f376c4a37.png#averageHue=%23fafafa&clientId=u8c29d1e2-1fcd-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=410&id=u64b37732&margin=%5Bobject%20Object%5D&name=image.png&originHeight=513&originWidth=840&originalType=binary&ratio=1&rotation=0&showTitle=false&size=75750&status=done&style=none&taskId=u4129a84b-eb0e-4044-a2f3-1d236a38fcc&title=&width=672)![image.png](https://cdn.nlark.com/yuque/0/2022/png/26091703/1662194562808-cfe31e25-772e-4b2a-adfc-699acad8ba89.png#averageHue=%23faf9f9&clientId=u8c29d1e2-1fcd-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=646&id=u45b15268&margin=%5Bobject%20Object%5D&name=image.png&originHeight=808&originWidth=1577&originalType=binary&ratio=1&rotation=0&showTitle=false&size=168404&status=done&style=none&taskId=uff2a6146-2c47-4357-9f34-7d4cafae48c&title=&width=1261.6)![image.png](https://cdn.nlark.com/yuque/0/2022/png/26091703/1662194921707-1d83d1a6-548a-4e92-a54e-4cbfe576058d.png#averageHue=%23faf8f7&clientId=u8c29d1e2-1fcd-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=529&id=u0b87a908&margin=%5Bobject%20Object%5D&name=image.png&originHeight=661&originWidth=1116&originalType=binary&ratio=1&rotation=0&showTitle=false&size=188794&status=done&style=none&taskId=u04f64942-c98f-40c8-a34a-56a7b356904&title=&width=892.8)
# AOP思想
![image.png](https://cdn.nlark.com/yuque/0/2022/png/26091703/1671433655522-ac10b1fd-5ca0-4acd-bc5e-bea0752ca9b2.png#averageHue=%23f4f4f4&clientId=ub3c28ca5-deb9-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=161&id=u5414aa0b&margin=%5Bobject%20Object%5D&name=image.png&originHeight=130&originWidth=560&originalType=binary&ratio=1&rotation=0&showTitle=false&size=28813&status=done&style=none&taskId=u52b97403-b6ab-493c-8937-749157a90a7&title=&width=694)
## 举例:  当前有dog,horse,pig类,它们都有run和eat方法和身高体重属性,抽象到animal类,子类通过继承来得到run,eat,身高体重
![image.png](https://cdn.nlark.com/yuque/0/2022/png/26091703/1671433493479-9846104e-dd4c-4f8b-b7d1-0c805615c403.png#averageHue=%23f9f8f7&clientId=ub3c28ca5-deb9-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=474&id=uc75eadc0&margin=%5Bobject%20Object%5D&name=image.png&originHeight=593&originWidth=734&originalType=binary&ratio=1&rotation=0&showTitle=false&size=189155&status=done&style=none&taskId=u082e881e-3d50-4185-9b56-3dab5997200&title=&width=587.2)![image.png](https://cdn.nlark.com/yuque/0/2022/png/26091703/1671433549761-86231749-3785-40a4-bb59-d2576e70801e.png#averageHue=%23f9f9f8&clientId=ub3c28ca5-deb9-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=326&id=u8b8a24c5&margin=%5Bobject%20Object%5D&name=image.png&originHeight=408&originWidth=640&originalType=binary&ratio=1&rotation=0&showTitle=false&size=91398&status=done&style=none&taskId=u407246a9-364f-47fa-80ee-012392eb78d&title=&width=512)![image.png](https://cdn.nlark.com/yuque/0/2022/png/26091703/1671433643226-5815b607-f14b-4102-8c75-b3c67cdfa49f.png#averageHue=%23fbfaf9&clientId=ub3c28ca5-deb9-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=697&id=u33da123e&margin=%5Bobject%20Object%5D&name=image.png&originHeight=871&originWidth=1468&originalType=binary&ratio=1&rotation=0&showTitle=false&size=182631&status=done&style=none&taskId=uce27a48c-d8c3-414d-ace6-fa73f3bde0c&title=&width=1174.4)
## 此时,抽象的animal类也出现了重复代码
![image.png](https://cdn.nlark.com/yuque/0/2022/png/26091703/1671434080136-5408bfdd-9442-4405-ba4d-f2b056d27291.png#averageHue=%23f9f8f7&clientId=ub3c28ca5-deb9-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=544&id=u52a131c8&margin=%5Bobject%20Object%5D&name=image.png&originHeight=680&originWidth=885&originalType=binary&ratio=1&rotation=0&showTitle=false&size=232913&status=done&style=none&taskId=u71c72414-7e9a-4453-b5d6-260565f2044&title=&width=708)
![image.png](https://cdn.nlark.com/yuque/0/2022/png/26091703/1671434200703-a50bbfb1-32d1-4c7d-a98f-cc58a70ef108.png#averageHue=%23fbf8f8&clientId=ub3c28ca5-deb9-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=564&id=u16ea66b9&margin=%5Bobject%20Object%5D&name=image.png&originHeight=705&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&size=138714&status=done&style=none&taskId=u3f3d1138-0ed7-44f7-8824-66b46cf6197&title=&width=1120)![image.png](https://cdn.nlark.com/yuque/0/2022/png/26091703/1671434309465-01fb9525-1a2e-4316-baff-752d3c36d27a.png#averageHue=%23f3f3f3&clientId=ub3c28ca5-deb9-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=114&id=u28ad93b6&margin=%5Bobject%20Object%5D&name=image.png&originHeight=120&originWidth=571&originalType=binary&ratio=1&rotation=0&showTitle=false&size=24441&status=done&style=none&taskId=u9ef4a944-831e-4e95-bb0c-e06adfd148c&title=&width=544.8000183105469)
## aop使用横向抽取机制,来分离业务逻辑和横切逻辑代码
![image.png](https://cdn.nlark.com/yuque/0/2022/png/26091703/1671434255635-fe3ed19b-ee1e-47dd-804a-eac20d4971e7.png#averageHue=%23f4f4f4&clientId=ub3c28ca5-deb9-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=534&id=ud80733ae&margin=%5Bobject%20Object%5D&name=image.png&originHeight=668&originWidth=1167&originalType=binary&ratio=1&rotation=0&showTitle=false&size=115189&status=done&style=none&taskId=uc3e30ab0-3bdb-4456-9d9a-aeebb0f9a5c&title=&width=933.6)
![image.png](https://cdn.nlark.com/yuque/0/2022/png/26091703/1671434325969-f8144c3b-e5d1-4856-8cd4-884b8498f003.png#averageHue=%23ececec&clientId=ub3c28ca5-deb9-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=52&id=uea8ded67&margin=%5Bobject%20Object%5D&name=image.png&originHeight=65&originWidth=866&originalType=binary&ratio=1&rotation=0&showTitle=false&size=31043&status=done&style=none&taskId=u9711a00b-2a70-4b8b-92e6-cbfca43e5e1&title=&width=692.8)![image.png](https://cdn.nlark.com/yuque/0/2022/png/26091703/1671434404132-fa918a59-16b9-43c2-b4ae-9c66e7be56fa.png#averageHue=%23f1f1f1&clientId=ub3c28ca5-deb9-4&crop=0&crop=0.1816&crop=1&crop=1&from=paste&height=248&id=u624d17bd&margin=%5Bobject%20Object%5D&name=image.png&originHeight=310&originWidth=898&originalType=binary&ratio=1&rotation=0&showTitle=false&size=109883&status=done&style=none&taskId=ubd79f3d9-8509-498d-a735-3f709616e20&title=&width=718)
# 手写实现IOC和AOP
## 问题引入: 银行转账案例->操作数据库进行转账
![image.png](https://cdn.nlark.com/yuque/0/2022/png/26091703/1671753127312-d617dc46-c175-4ec5-ac61-08f437bbdf0e.png#averageHue=%232b3037&clientId=uffa915d0-644b-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=573&id=u56b8c156&margin=%5Bobject%20Object%5D&name=image.png&originHeight=840&originWidth=469&originalType=binary&ratio=1&rotation=0&showTitle=false&size=554894&status=done&style=none&taskId=u03e2bc41-ac8d-4a27-9a02-90cd10501c6&title=&width=320.20001220703125)
### dao
#### impl/JdbcAccountDaoImpl 
```java
package org.malred.edu.dao.impl;
public class JdbcAccountDaoImpl implements AccountDao {
    @Override
    public Account queryAccountByCardNo(String cardNo) throws Exception {
//从连接池获取连接
        Connection con = DruidUtils.getInstance().getConnection();
        String sql = "select * from account where cardNo=?";
        PreparedStatement preparedStatement = con.prepareStatement(sql);
        preparedStatement.setString(1, cardNo);
        ResultSet resultSet = preparedStatement.executeQuery();
        Account account = new Account();
        while (resultSet.next()) {
            account.setCardNo(resultSet.getString("cardNo"));
            account.setName(resultSet.getString("name"));
            account.setMoney(resultSet.getInt("money"));
        }
        resultSet.close();
        preparedStatement.close();
        con.close();
        return account;
    }

    @Override
    public int updateAccountByCardNo(Account account) throws Exception {
//从连接池获取连接
        Connection con = DruidUtils.getInstance().getConnection();
        String sql = "update account set money=? where cardNo=?";
        PreparedStatement preparedStatement = con.prepareStatement(sql);
        preparedStatement.setInt(1, (int) account.getMoney());
        preparedStatement.setString(2, account.getCardNo());
        int i = preparedStatement.executeUpdate();
        preparedStatement.close();
        con.close();
        return i;
    }
}
```
#### AccountDao
```java
package org.malred.edu.dao; 
public interface AccountDao {
    Account queryAccountByCardNo(String cardNo) throws Exception;

    int updateAccountByCardNo(Account account) throws Exception;
} 
```
### pojo
#### Account
```java
package org.malred.edu.pojo;  
public class Account {

    private String name;
    private long money;
    private String cardNo;

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public long getMoney() {
        return money;
    }

    public void setMoney(long money) {
        this.money = money;
    }

    public String getCardNo() {
        return cardNo;
    }

    public void setCardNo(String cardNo) {
        this.cardNo = cardNo;
    }
}
```
#### Result
```java
package org.malred.edu.pojo; 
public class Result {
 
    private String status;
    private String message;

    public String getStatus() {
        return status;
    }

    public void setStatus(String status) {
        this.status = status;
    }

    public String getMessage() {
        return message;
    }

    public void setMessage(String message) {
        this.message = message;
    }

    @Override
    public String toString() {
        return "Result{" +
            "status='" + status + '\'' +
            ", message='" + message + '\'' +
            '}';
    }
}
```
### service
#### impl/TransferServiceImpl
```java
package org.malred.edu.service.impl;  
public class TransferServiceImpl implements TransferService {
    private AccountDao accountDao = new JdbcAccountDaoImpl();
    @Override
    public void transfer(String fromCardNo, String toCardNo, int money)
    throws Exception {
        Account from = accountDao.queryAccountByCardNo(fromCardNo);
        Account to = accountDao.queryAccountByCardNo(toCardNo);
        from.setMoney(from.getMoney()-money);
        to.setMoney(to.getMoney()+money);
        accountDao.updateAccountByCardNo(from);
        accountDao.updateAccountByCardNo(to);
    }
}
```
#### TransferService
```java
package org.malred.edu.service; 
public interface TransferService {
    void transfer(String fromCardNo, String toCardNo, int money) throws Exception;
}
```
### servlet
#### TransferServlet
```java
package org.malred.edu.servlet; 
@WebServlet(name="transferServlet",urlPatterns = "/transferServlet")
public class TransferServlet extends HttpServlet {
        // 1. 实例化service层对象
        private TransferService transferService = new TransferServiceImpl();

        @Override
        protected void doGet(HttpServletRequest req, HttpServletResponse resp)
        throws ServletException, IOException {
            doPost(req, resp);
        }

        @Override
        protected void doPost(HttpServletRequest req, HttpServletResponse
                              resp) throws ServletException, IOException {
            // 设置请求体的字符编码
            req.setCharacterEncoding("UTF-8");
            String fromCardNo = req.getParameter("fromCardNo");
            String toCardNo = req.getParameter("toCardNo");
            String moneyStr = req.getParameter("money");
            int money = Integer.parseInt(moneyStr);
            Result result = new Result();
            try {
                // 2. 调⽤service层⽅法
                transferService.transfer(fromCardNo, toCardNo, money);
                result.setStatus("200");
            } catch (Exception e) {
                e.printStackTrace();
                result.setStatus("201");
                result.setMessage(e.toString());
            }
            // 响应
            resp.setContentType("application/json;charset=utf-8");
            resp.getWriter().print(JsonUtils.object2Json(result));
        }
    }
```
### utils
#### ConnectionUtils
```java
package org.malred.edu.utils; 
public class ConnectionUtils {

    /*private ConnectionUtils() {

}

private static ConnectionUtils connectionUtils = new ConnectionUtils();

public static ConnectionUtils getInstance() {
return connectionUtils;
}*/


    private ThreadLocal<Connection> threadLocal = new ThreadLocal<>(); // 存储当前线程的连接

    /**
* 从当前线程获取连接
*/
    public Connection getCurrentThreadConn() throws SQLException {
        /**
* 判断当前线程中是否已经绑定连接，如果没有绑定，需要从连接池获取一个连接绑定到当前线程
*/
        Connection connection = threadLocal.get();
        if(connection == null) {
            // 从连接池拿连接并绑定到线程
            connection = DruidUtils.getInstance().getConnection();
            // 绑定到当前线程
            threadLocal.set(connection);
        }
        return connection;

    }
}
```
#### DruidUtils
```java
package org.malred.edu.utils; 
public class DruidUtils {

    private DruidUtils(){
    }

    private static DruidDataSource druidDataSource = new DruidDataSource();


    static {
        druidDataSource.setDriverClassName("com.mysql.jdbc.Driver");
        druidDataSource.setUrl("jdbc:mysql://localhost:3307/test");
        druidDataSource.setUsername("root");
        druidDataSource.setPassword("123456");

    }

    public static DruidDataSource getInstance() {
        return druidDataSource;
    }

}
```
#### JsonUtils
```java
package org.malred.edu.utils; 
/**
* JSON工具类（使用的是jackson实现的）
*/
public class JsonUtils {

    private static final ObjectMapper MAPPER = new ObjectMapper();

    /**
* 将对象转换成json字符串。
* @param data
* @return
*/
    public static String object2Json(Object data) {
        try {
            String string = MAPPER.writeValueAsString(data);
            return string;
        } catch (JsonProcessingException e) {
            e.printStackTrace();
        }
        return null;
    }

    /**
* 将json结果集转化为对象
* 
* @param jsonData json数据
* @param beanType 对象中的object类型
* @return
*/
    public static <T> T json2Pojo(String jsonData, Class<T> beanType) {
        try {
            T t = MAPPER.readValue(jsonData, beanType);
            return t;
        } catch (Exception e) {
            e.printStackTrace();
        }
        return null;
    }

    /**
* 将json数据转换成pojo对象list
* @param jsonData
* @param beanType
* @return
*/
    public static <T>List<T> json2List(String jsonData, Class<T> beanType) {
        JavaType javaType = MAPPER.getTypeFactory().constructParametricType(List.class, beanType);
        try {
            List<T> list = MAPPER.readValue(jsonData, javaType);
            return list;
        } catch (Exception e) {
            e.printStackTrace();
        }

        return null;
    }

}
```
#### TransactionManager
```java
package org.malred.edu.utils;  
public class TransactionManager {

    private ConnectionUtils connectionUtils;

    public void setConnectionUtils(ConnectionUtils connectionUtils) {
        this.connectionUtils = connectionUtils;
    }

    /*private TransactionManager(){

}

private static TransactionManager transactionManager = new TransactionManager();

public static TransactionManager getInstance() {
return  transactionManager;
}*/



    // 开启手动事务控制
    public void beginTransaction() throws SQLException {
        connectionUtils.getCurrentThreadConn().setAutoCommit(false);
    }


    // 提交事务
    public void commit() throws SQLException {
        connectionUtils.getCurrentThreadConn().commit();
    }


    // 回滚事务
    public void rollback() throws SQLException {
        connectionUtils.getCurrentThreadConn().rollback();
    }
}
```
![image.png](https://cdn.nlark.com/yuque/0/2022/png/26091703/1671753005174-d0a8ddb6-21da-419a-8f90-b24eb016328a.png#averageHue=%2361737d&clientId=uffa915d0-644b-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=277&id=ud4fad236&margin=%5Bobject%20Object%5D&name=image.png&originHeight=337&originWidth=458&originalType=binary&ratio=1&rotation=0&showTitle=true&size=209969&status=done&style=none&taskId=u3dacb918-562d-4561-849e-e96118fbbab&title=maven%E6%89%93%E5%8C%85%E6%96%B9%E5%BC%8Fwar%2C%E7%94%A8tomcat7%3Arun%E5%90%AF%E5%8A%A8&width=376.3999938964844 "maven打包方式war,用tomcat7:run启动")
## 问题: 
![image.png](https://cdn.nlark.com/yuque/0/2022/png/26091703/1671699340140-994ebc24-97ed-4732-9eda-d6913edb6fcd.png#averageHue=%23faf5f4&clientId=uebe7cf58-3145-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=644&id=u25d5b219&margin=%5Bobject%20Object%5D&name=image.png&originHeight=805&originWidth=1587&originalType=binary&ratio=1&rotation=0&showTitle=false&size=481618&status=done&style=none&taskId=u698d4b6a-c18a-4925-aa9f-1390e681704&title=&width=1269.6)
## 1,new关键字耦合问题解决方案
![image.png](https://cdn.nlark.com/yuque/0/2022/png/26091703/1671708453025-e840385e-c9dc-4d86-8395-f904bd8eaf3d.png#averageHue=%23f6f2f2&clientId=uebe7cf58-3145-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=709&id=u25c0d208&margin=%5Bobject%20Object%5D&name=image.png&originHeight=886&originWidth=1432&originalType=binary&ratio=1&rotation=0&showTitle=false&size=432002&status=done&style=none&taskId=u4c01c25e-f552-4c0d-ac6b-cdb9e819aae&title=&width=1145.6)
### 拓展: 设计模式(工厂模式/单例模式)
### 创建beans.xml
```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!--跟标签beans，里面有很多的子标签bean，每一个bean子标签都代表一个类的配置-->
<beans>
    <!--通过class全类名来找到要框架来实例化的类-->
    <!--id作为外部获取bean的依据-->
    <bean id="accountDao" class="org.malred.edu.dao.impl.JdbcAccountDaoImpl"></bean>
    <bean id="transferService" class="org.malred.edu.service.impl.TransferServiceImpl"></bean>
</beans>
```
### 创建工厂类factory.BeanFactory
```java
package org.malred.edu.factory; 
/**
 * 工厂类,用反射实例化对象
 */
public class BeanFactory {
    /**
     * 1,解析xml,通过反射实例化对象,存入一个map
     * 2,对外提供获取bean的接口(根据id获取)
     */
    private static Map<String, Object> map = new HashMap<>();

    // 静态方法,类加载时执行,1解析xml,并实例化对象放入map
    static {
        // 读取xml
        InputStream resourceAsStream = BeanFactory.class.getClassLoader().getResourceAsStream("beans.xml");
        // 解析xml
        SAXReader saxReader = new SAXReader();
        try {
            Document document = saxReader.read(resourceAsStream);
            // 获取根元素
            Element rootElement = document.getRootElement();
            // 得到所有bean标签
            List<Element> beanList = rootElement.selectNodes("//bean");
            for (int i = 0; i < beanList.size(); i++) {
                Element element = beanList.get(i);
                // 处理每个bean元素,获取该元素的id和class属性
                String id = element.attributeValue("id");//accountDao
                //org.malred.edu.dao.impl.JdbcAccountDaoImpl
                String clazz = element.attributeValue("class");
                // 通过反射实例化对象
                Class<?> aClass = Class.forName(clazz);
                Object o = aClass.newInstance();// 实例化对象
                // 存放到map中
                map.put(id, o);
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    // 2,对外提供获取实例对象的接口(根据id获取)
    public static Object getBean(String id) {
        return map.get(id);
    }
}
```
### 引入解析xml的依赖
```xml
<!--解析xml的依赖-->
<dependency>
  <groupId>dom4j</groupId>
  <artifactId>dom4j</artifactId>
  <version>1.6.1</version>
</dependency>
<!--xpath表达式依赖-->
<dependency>
  <groupId>jaxen</groupId>
  <artifactId>jaxen</artifactId>
  <version>1.1.6</version>
</dependency>
```
![image.png](https://cdn.nlark.com/yuque/0/2022/png/26091703/1671758944966-a7facab0-db1b-4a26-8fd1-f4b39ffb01d5.png#averageHue=%23423f5e&clientId=u18862189-d3db-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=338&id=ud2f9a8e4&margin=%5Bobject%20Object%5D&name=image.png&originHeight=422&originWidth=1038&originalType=binary&ratio=1&rotation=0&showTitle=false&size=581157&status=done&style=none&taskId=ubf728043-c9f0-4f00-9116-d103eae53a4&title=&width=830.4)
### 使用
#### TransferServiceImpl
```java
package org.malred.edu.service.impl; 
public class TransferServiceImpl implements TransferService {
    //    private AccountDao accountDao = new JdbcAccountDaoImpl();
    private AccountDao accountDao = (AccountDao) BeanFactory.getBean("accountDao");

    @Override
    public void transfer(String fromCardNo, String toCardNo, int money)
            throws Exception {
        Account from = accountDao.queryAccountByCardNo(fromCardNo);
        Account to = accountDao.queryAccountByCardNo(toCardNo);
        from.setMoney(from.getMoney() - money);
        to.setMoney(to.getMoney() + money);
        accountDao.updateAccountByCardNo(from);
        accountDao.updateAccountByCardNo(to);
    }
}
```
#### TransferServlet
```java
package org.malred.edu.servlet; 
@WebServlet(name = "transferServlet", urlPatterns = "/transferServlet")
public class TransferServlet extends HttpServlet {
    // 1. 实例化service层对象
//    private TransferService transferService = new TransferServiceImpl();
    private TransferService transferService = 
            (TransferService) BeanFactory.getBean("transferService");

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp)
            throws ServletException, IOException {
        doPost(req, resp);
    }

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse
            resp) throws ServletException, IOException {
// 设置请求体的字符编码
        req.setCharacterEncoding("UTF-8");
        String fromCardNo = req.getParameter("fromCardNo");
        String toCardNo = req.getParameter("toCardNo");
        String moneyStr = req.getParameter("money");
        int money = Integer.parseInt(moneyStr);
        Result result = new Result();
        try {
// 2. 调⽤service层⽅法
            transferService.transfer(fromCardNo, toCardNo, money);
            result.setStatus("200");
        } catch (Exception e) {
            e.printStackTrace();
            result.setStatus("201");
            result.setMessage(e.toString());
        }
// 响应
        resp.setContentType("application/json;charset=utf-8");
        resp.getWriter().print(JsonUtils.object2Json(result));
    }
}
```
![image.png](https://cdn.nlark.com/yuque/0/2022/png/26091703/1671762076407-b73b36da-7002-4dcf-bd66-0df20e2635ea.png#averageHue=%2300b28a&clientId=u18862189-d3db-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=611&id=u8e0365ea&margin=%5Bobject%20Object%5D&name=image.png&originHeight=764&originWidth=1565&originalType=binary&ratio=1&rotation=0&showTitle=false&size=47551&status=done&style=none&taskId=u13df20d5-a97c-40e1-8692-bce3e678229&title=&width=1252)
### 优化->
![image.png](https://cdn.nlark.com/yuque/0/2022/png/26091703/1671762248464-6e43a2d7-3bf2-4f9a-8203-8672036518d4.png#averageHue=%233d505f&clientId=u18862189-d3db-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=78&id=u6b8eec68&margin=%5Bobject%20Object%5D&name=image.png&originHeight=98&originWidth=471&originalType=binary&ratio=1&rotation=0&showTitle=false&size=71398&status=done&style=none&taskId=ud4c20148-413a-46bc-8b6b-e54e5433db9&title=&width=376.8)  
```java
package org.malred.edu.factory; 
/**
* 工厂类,用反射实例化对象
*/
public class BeanFactory {
    /**
* 1,解析xml,通过反射实例化对象,存入一个map
* 2,对外提供获取bean的接口(根据id获取)
*/
    private static Map<String, Object> map = new HashMap<>();

    // 静态方法,类加载时执行,1解析xml,并实例化对象放入map
    static {
        // 读取xml
        InputStream resourceAsStream = BeanFactory.class.getClassLoader().getResourceAsStream("beans.xml");
        // 解析xml
        SAXReader saxReader = new SAXReader();
        try {
            Document document = saxReader.read(resourceAsStream);
            // 获取根元素
            Element rootElement = document.getRootElement();
            // 得到所有bean标签
            List<Element> beanList = rootElement.selectNodes("//bean");
            for (int i = 0; i < beanList.size(); i++) {
                Element element = beanList.get(i);
                // 处理每个bean元素,获取该元素的id和class属性
                String id = element.attributeValue("id");//accountDao
                //org.malred.edu.dao.impl.JdbcAccountDaoImpl
                String clazz = element.attributeValue("class");
                // 通过反射实例化对象
                Class<?> aClass = Class.forName(clazz);
                Object o = aClass.newInstance();// 实例化对象
                // 存放到map中
                map.put(id, o);
            }
            // 实例化完成后(维护对象依赖关系),检查哪些对象需要传值,根据它的配置,传入相应的值
            // bean有property子标签的就需要传值
            List<Element> propertyList = rootElement.selectNodes("//property");
            // 解析property,获取父元素
            for (int i = 0; i < propertyList.size(); i++) {
                // <property name="AccountDao" ref="accountDao"></property>
                Element element = propertyList.get(i);
                // 获取name属性
                String name = element.attributeValue("name");
                // 获取ref属性
                String ref = element.attributeValue("ref");
                // 找到当前需要传值的bean(处理依赖关系)
                Element parent = element.getParent();
                // 得到父元素
                String pid = parent.attributeValue("id");
                Object parentObj = map.get(pid);
                // 遍历父元素所有方法,获取set方法
                Method[] methods = parentObj.getClass().getMethods();
                for (int j = 0; j < methods.length; j++) {
                    Method method = methods[j];
                    // 忽略大小写地匹配 方法名 == set+name
                    if (method.getName().equalsIgnoreCase("set" + name)) {//setAccountDao
                        // 参数1: 是谁的方法
                    // 参数2[不定长]: 方法(实)参数
                    method.invoke(parentObj, map.get(ref));
                }
                }
                    // 处理后的父元素重新放到map
                    map.put(pid, parentObj);
                }
                } catch (Exception e) {
                    e.printStackTrace();
                }
                }

                    // 2,对外提供获取实例对象的接口(根据id获取)
                    public static Object getBean(String id) {
                    return map.get(id);
                }
                }
```
### beans.xml
```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!--跟标签beans，里面有很多的子标签bean，每一个bean子标签都代表一个类的配置-->
<beans>
    <!--通过class全类名来找到要框架来实例化的类-->
    <!--id作为外部获取bean的依据-->
    <bean id="accountDao" class="org.malred.edu.dao.impl.JdbcAccountDaoImpl"></bean>
    <bean id="transferService" class="org.malred.edu.service.impl.TransferServiceImpl">
        <!--通过添加标签来让框架帮忙注入属性,name是属性名,ref是对应的bean的id-->
        <!--通过set+name锁定set方法,通过反射来调用set方法传值-->
        <property name="AccountDao" ref="accountDao"></property>
    </bean>
</beans>
```
### 使用
```java
package org.malred.edu.service.impl;
public class TransferServiceImpl implements TransferService {
    //    private AccountDao accountDao = new JdbcAccountDaoImpl();
//    private AccountDao accountDao = (AccountDao) BeanFactory.getBean("accountDao");
    // 更好的形式,让框架来注入属性
    private AccountDao accountDao;

    // 让框架可以反射设置值
    public void setAccountDao(AccountDao accountDao) {
        this.accountDao = accountDao;
    }

    @Override
    public void transfer(String fromCardNo, String toCardNo, int money)
            throws Exception {
        Account from = accountDao.queryAccountByCardNo(fromCardNo);
        Account to = accountDao.queryAccountByCardNo(toCardNo);
        from.setMoney(from.getMoney() - money);
        to.setMoney(to.getMoney() + money);
        accountDao.updateAccountByCardNo(from);
        accountDao.updateAccountByCardNo(to);
    }
}
```
![image.png](https://cdn.nlark.com/yuque/0/2022/png/26091703/1671763348945-e4173b91-fdf4-4866-aeab-77ba2254d5bc.png#averageHue=%23e6c287&clientId=u18862189-d3db-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=485&id=u6ea7a68e&margin=%5Bobject%20Object%5D&name=image.png&originHeight=606&originWidth=660&originalType=binary&ratio=1&rotation=0&showTitle=false&size=19372&status=done&style=none&taskId=ud03f8ced-6dd7-403b-b4d2-6bd7b67fbaf&title=&width=528)
## 2,没有事务控制问题解决方案
### 模拟转账异常
![image.png](https://cdn.nlark.com/yuque/0/2022/png/26091703/1671763555508-c905e007-685f-4545-af8a-7e3c416afc05.png#averageHue=%2333343d&clientId=u18862189-d3db-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=377&id=u54c5713c&margin=%5Bobject%20Object%5D&name=image.png&originHeight=471&originWidth=926&originalType=binary&ratio=1&rotation=0&showTitle=false&size=552054&status=done&style=none&taskId=uee13c5c2-3739-4df5-bfe7-c37e4ea0ec2&title=&width=740.8)![image.png](https://cdn.nlark.com/yuque/0/2022/png/26091703/1671763563153-3c95d3c6-94b1-4ca3-9c85-2ded8803484c.png#averageHue=%23efce93&clientId=u18862189-d3db-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=493&id=ua9e96c60&margin=%5Bobject%20Object%5D&name=image.png&originHeight=616&originWidth=731&originalType=binary&ratio=1&rotation=0&showTitle=false&size=23573&status=done&style=none&taskId=uaf58e7a6-1d88-44f3-8489-2ca58129f45&title=&width=584.8)
![image.png](https://cdn.nlark.com/yuque/0/2022/png/26091703/1671763539383-985e5a67-62f3-4087-b8d9-0dfc491fe4fa.png#averageHue=%23373238&clientId=u18862189-d3db-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=234&id=ueb7fb325&margin=%5Bobject%20Object%5D&name=image.png&originHeight=293&originWidth=681&originalType=binary&ratio=1&rotation=0&showTitle=false&size=248193&status=done&style=none&taskId=u2eceed01-32de-4017-9d80-1afc29e3a04&title=&width=544.8)
### 解决方案
![image.png](https://cdn.nlark.com/yuque/0/2022/png/26091703/1671769884907-30773ec9-281a-4cf9-8fe9-6c3e5890fcb9.png#averageHue=%23fbf5f4&clientId=ued658dc1-a871-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=723&id=u4e3bd677&margin=%5Bobject%20Object%5D&name=image.png&originHeight=904&originWidth=1731&originalType=binary&ratio=1&rotation=0&showTitle=false&size=594448&status=done&style=none&taskId=u6da4494e-99b4-488e-9f5a-f473c8083a3&title=&width=1384.8)
### ConnectionUtils
```java
package org.malred.edu.utils; 
public class ConnectionUtils {
    // 保证当前类是单例,否则无法保证每次使用该类,其threadlocal都同一个
    private ConnectionUtils() {
    }

    private static ConnectionUtils connectionUtils = new ConnectionUtils();

    public static ConnectionUtils geInstance() {
        return connectionUtils;
    }

    /**
     * 总结而言：ThreadLocal是一个将在多线程中为每一个线程创建单独的变量副本的类;
     * 当使用ThreadLocal来维护变量时, ThreadLocal会为每个线程创建单独的变量副本,
     * 避免因多线程操作共享变量而导致的数据不一致的情况
     * ------
     * 著作权归@pdai所有
     * 原文链接：https://pdai.tech/md/java/thread/java-thread-x-threadlocal.html
     */
    // 存储当前线程的连接
    private static ThreadLocal<Connection> threadLocal = new ThreadLocal<>();

    /**
     * 从当前线程获取连接
     */
    public static Connection getCurrentThreadConn() throws SQLException {
        // 判断当前线程是否已经绑定连接,如果没有,就1,从连接池获取,2,并绑定到当前线程
        Connection connection = threadLocal.get();
        if (connection == null) {
            // 从连接池拿连接
            connection = DruidUtils.getInstance().getConnection();
            // 绑定到当前线程
            threadLocal.set(connection);
        }
        return connection;
    }
}
```
### TransactionManager
```java
package org.malred.edu.utils; 
/**
* 管理事务的类(开启/提交/回滚)
*/
public class TransactionManager {

    // 也是单例
    private static TransactionManager transactionManager = new TransactionManager();

    public static TransactionManager getInstance() {
        return transactionManager;
    }

    // 开启手动事务控制
    public void beginTransaction() throws SQLException {
        ConnectionUtils.geInstance().getCurrentThreadConn().setAutoCommit(false);
    }


    // 提交事务
    public void commit() throws SQLException {
        ConnectionUtils.geInstance().getCurrentThreadConn().commit();
    }


    // 回滚事务
    public void rollback() throws SQLException {
        ConnectionUtils.geInstance().getCurrentThreadConn().rollback();
    }
}
```
### JdbcAccountDaoImpl(使连接绑定单线程)
```java
package org.malred.edu.dao.impl; 
public class JdbcAccountDaoImpl implements AccountDao {
    @Override
    public Account queryAccountByCardNo(String cardNo) throws Exception {
        //从连接池获取连接
        // Connection con = DruidUtils.getInstance().getConnection();
        Connection con = ConnectionUtils.geInstance().getCurrentThreadConn();
        String sql = "select * from account where cardNo=?";
        PreparedStatement preparedStatement = con.prepareStatement(sql);
        preparedStatement.setString(1, cardNo);
        ResultSet resultSet = preparedStatement.executeQuery();
        Account account = new Account();
        while (resultSet.next()) {
            account.setCardNo(resultSet.getString("cardNo"));
            account.setName(resultSet.getString("name"));
            account.setMoney(resultSet.getInt("money"));
        }
        resultSet.close();
        preparedStatement.close();
        // 不能关闭该连接,否则下次getCurrentThreadConn时会重新获取连接(因为上传的连接被销毁,判断为未绑定)
        //        con.close();
        return account;
    }

    @Override
    public int updateAccountByCardNo(Account account) throws Exception {
        //从连接池获取连接
        // 改造为从当前线程中获取绑定的connect链接
        //        Connection con = DruidUtils.getInstance().getConnection();
        Connection con = ConnectionUtils.geInstance().getCurrentThreadConn();
        String sql = "update account set money=? where cardNo=?";
        PreparedStatement preparedStatement = con.prepareStatement(sql);
        preparedStatement.setInt(1, (int) account.getMoney());
        preparedStatement.setString(2, account.getCardNo());
        int i = preparedStatement.executeUpdate();
        preparedStatement.close();
        //        con.close(); // 不能关闭连接,因为当前线程已经绑定,关了就没有绑定了
        return i;
    }
}
```
### TransferServiceImpl(添加事务控制)
```java
package org.malred.edu.service.impl; 
public class TransferServiceImpl implements TransferService {
    //    private AccountDao accountDao = new JdbcAccountDaoImpl();
    //    private AccountDao accountDao = (AccountDao) BeanFactory.getBean("accountDao");
    // 更好的形式,让框架来注入属性
    private AccountDao accountDao;

    // 让框架可以反射设置值
    public void setAccountDao(AccountDao accountDao) {
        this.accountDao = accountDao;
    }

    @Override
    public void transfer(String fromCardNo, String toCardNo, int money) throws Exception {
        try {
            // 开启事务(关闭事务的自动提交,jdbc默认自动提交)
            //            ConnectionUtils.geInstance().getCurrentThreadConn().setAutoCommit(false);
            TransactionManager.getInstance().beginTransaction();
            Account from = accountDao.queryAccountByCardNo(fromCardNo);
            Account to = accountDao.queryAccountByCardNo(toCardNo);
            from.setMoney(from.getMoney() - money);
            to.setMoney(to.getMoney() + money);
            accountDao.updateAccountByCardNo(from);
            int c = 1 / 0;//人为异常
            accountDao.updateAccountByCardNo(to);
            // 提交事务
            //            ConnectionUtils.geInstance().getCurrentThreadConn().commit();
            TransactionManager.getInstance().commit();
        } catch (Exception e) {
            e.printStackTrace();
            // 回滚事务
            //            ConnectionUtils.geInstance().getCurrentThreadConn().rollback();
            TransactionManager.getInstance().rollback();
            throw e; // 抛出异常,让servlet捕获
        }
    }
}
```
### 优化前置: jkd动态代理拓展
#### 中介(代理类)帮你找房,然后可以在租房中执行额外操作(增强)
![image.png](https://cdn.nlark.com/yuque/0/2022/png/26091703/1671778305208-26d7809f-7fca-4532-a375-24bedc38b2e5.png#averageHue=%23f8f8f7&clientId=ued658dc1-a871-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=321&id=ue0331d6c&margin=%5Bobject%20Object%5D&name=image.png&originHeight=401&originWidth=776&originalType=binary&ratio=1&rotation=0&showTitle=false&size=154441&status=done&style=none&taskId=u1a173c74-a66e-4bc6-bad3-545356941af&title=&width=620.8)
#### 租房人找中介(传入代理类),让中介执行代理方法
![image.png](https://cdn.nlark.com/yuque/0/2022/png/26091703/1671778366140-9ca288c6-1e57-4d18-ae92-61437ea345e9.png#averageHue=%23fafaf9&clientId=ued658dc1-a871-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=291&id=uc8fc881f&margin=%5Bobject%20Object%5D&name=image.png&originHeight=364&originWidth=1069&originalType=binary&ratio=1&rotation=0&showTitle=false&size=137574&status=done&style=none&taskId=uf908ca68-63c6-49bf-b8da-86fe93318a3&title=&width=855.2)
#### 动态代理创建代理对象方法->参数1: 类加载器;参数2: 要代理的方法所在接口;参数3: 实现前一个参数指定的接口的类(里面要有一个invoke方法,用来指定代理方法执行逻辑)
![image.png](https://cdn.nlark.com/yuque/0/2022/png/26091703/1671778507244-8b59a314-4190-4f25-b313-09ff3a0ce123.png#averageHue=%23f6f6f4&clientId=ued658dc1-a871-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=216&id=u1a6078dd&margin=%5Bobject%20Object%5D&name=image.png&originHeight=270&originWidth=972&originalType=binary&ratio=1&rotation=0&showTitle=false&size=108561&status=done&style=none&taskId=uf75f1460-63ff-46e9-896a-3a1e16c3dfb&title=&width=777.6)
#### invoke方法,参数1: 代理对象本身,参数2: 代理对象具有的方法;参数3: 方法的参数
![image.png](https://cdn.nlark.com/yuque/0/2022/png/26091703/1671778711004-e0057f2a-318a-48c9-894f-0a5a830d7b91.png#averageHue=%23f0f0f0&clientId=ued658dc1-a871-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=110&id=uc46945a3&margin=%5Bobject%20Object%5D&name=image.png&originHeight=137&originWidth=1104&originalType=binary&ratio=1&rotation=0&showTitle=false&size=73701&status=done&style=none&taskId=uf86e2cbe-04f5-4b1f-aac4-bfd430005cd&title=&width=883.2)
![image.png](https://cdn.nlark.com/yuque/0/2022/png/26091703/1671778954820-86617a37-19f1-4abc-8a66-74ef1f96916b.png#averageHue=%23fafaf9&clientId=ued658dc1-a871-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=550&id=u84da7a24&margin=%5Bobject%20Object%5D&name=image.png&originHeight=687&originWidth=1308&originalType=binary&ratio=1&rotation=0&showTitle=false&size=251936&status=done&style=none&taskId=u6154b473-9b68-45b3-9dfd-a7221ee4a9b&title=&width=1046.4)
#### 可以通过工厂类统一生成代理对象并返回给外部
![image.png](https://cdn.nlark.com/yuque/0/2022/png/26091703/1671779021535-a70084f3-35a3-42ef-8ea4-8fab6c61d005.png#averageHue=%23fbfbfa&clientId=ued658dc1-a871-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=543&id=u316deb8e&margin=%5Bobject%20Object%5D&name=image.png&originHeight=679&originWidth=1257&originalType=binary&ratio=1&rotation=0&showTitle=false&size=236125&status=done&style=none&taskId=u98508c71-2d9f-4a00-907e-903b26bef40&title=&width=1005.6)
### 优化前置: cglib动态代理拓展
#### cglib是通过方法拦截器来拦截并增强方法
#### 参数解读: enhancer.create(代理对象,方法拦截器)
#### 参数解读: intercept(代理对象,当前执行的方法,方法的参数,方法的代理对象
![image.png](https://cdn.nlark.com/yuque/0/2022/png/26091703/1671779321301-ad681749-3b01-4d0b-a2e8-084e8190af54.png#averageHue=%23f9f9f8&clientId=ued658dc1-a871-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=418&id=ub553c194&margin=%5Bobject%20Object%5D&name=image.png&originHeight=522&originWidth=1595&originalType=binary&ratio=1&rotation=0&showTitle=false&size=325617&status=done&style=none&taskId=u4e91fe74-fb86-4445-88e2-4349c294236&title=&width=1276)
#### 注意,cglib传入的委托对象不需要实现接口(cglib的代理方法没有接口对象这个参数),而jdk动态代理需要
![image.png](https://cdn.nlark.com/yuque/0/2022/png/26091703/1671779459520-48336b8c-ecd6-4843-944e-78b71d271739.png#averageHue=%23fafaf9&clientId=ued658dc1-a871-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=385&id=u34cc5aef&margin=%5Bobject%20Object%5D&name=image.png&originHeight=481&originWidth=1421&originalType=binary&ratio=1&rotation=0&showTitle=false&size=198784&status=done&style=none&taskId=ua0dbe6a9-2bc8-4f69-adcf-fb0aedd2d96&title=&width=1136.8)
### 优化(当前需要手动加事务控制)->动态代理自动加
![image.png](https://cdn.nlark.com/yuque/0/2022/png/26091703/1671780145373-ac14cd50-4aaa-42db-9d49-48207951749e.png#averageHue=%23faf8f7&clientId=ued658dc1-a871-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=490&id=u2a13ad78&margin=%5Bobject%20Object%5D&name=image.png&originHeight=612&originWidth=1217&originalType=binary&ratio=1&rotation=0&showTitle=false&size=198523&status=done&style=none&taskId=u7e7755fb-1742-4f35-817f-f7a5580d2df&title=&width=973.6)
#### ProxyFactory
```java
package org.malred.edu.factory; 
/**
 * 工厂类: 统一返回代理类
 */
public class ProxyFactory {
    // 单例
    private static ProxyFactory instance = new ProxyFactory();

    private ProxyFactory() {
    }

    public static ProxyFactory getInstance() {
        return instance;
    }

    /**
     * jdk动态代理
     *
     * @param obj 传入实现了接口的类
     */
    public Object getJdkProxy(Object obj) throws Exception {
        // 获取代理对象
        return Proxy.newProxyInstance(obj.getClass().getClassLoader(), obj.getClass().getInterfaces(),
                new InvocationHandler() {
                    @Override
                    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
                        Object result = null;
                        try {
                            // 开启事务(关闭事务的自动提交,jdbc默认自动提交)
                            TransactionManager.getInstance().beginTransaction();
                            // 调用原方法逻辑
                            result = method.invoke(obj, args);
                            // 提交事务
                            TransactionManager.getInstance().commit();
                        } catch (Exception e) {
                            e.printStackTrace();
                            // 回滚事务
                            TransactionManager.getInstance().rollback();
                            throw e; // 抛出异常,让servlet捕获
                        }
                        return result;
                    }
                });
    }

    /**
     * cglib动态代理
     * @param obj 类(不需要实现接口)
     * @return
     * @throws Exception
     */
    public Object getCglibProxy(Object obj) throws Exception {
        return Enhancer.create(obj.getClass(), new MethodInterceptor() {
            @Override
            public Object intercept(Object o, Method method, Object[] objects, MethodProxy methodProxy) throws Throwable {
                Object result = null;
                try {
                    // 开启事务(关闭事务的自动提交,jdbc默认自动提交)
                    TransactionManager.getInstance().beginTransaction();
                    // 调用原方法逻辑
                    result = method.invoke(obj, objects);
                    // 提交事务
                    TransactionManager.getInstance().commit();
                } catch (Exception e) {
                    e.printStackTrace();
                    // 回滚事务
                    TransactionManager.getInstance().rollback();
                    throw e; // 抛出异常,让servlet捕获
                }
                return result;
            }
        });
    }
}
```
#### TransferServiceImpl(不需要手动事务控制了)
```java
package org.malred.edu.service.impl; 
public class TransferServiceImpl implements TransferService {
    //    private AccountDao accountDao = new JdbcAccountDaoImpl();
//    private AccountDao accountDao = (AccountDao) BeanFactory.getBean("accountDao");
    // 更好的形式,让框架来注入属性
    private AccountDao accountDao;

    // 让框架可以反射设置值
    public void setAccountDao(AccountDao accountDao) {
        this.accountDao = accountDao;
    }

    @Override
    public void transfer(String fromCardNo, String toCardNo, int money) throws Exception {
//        try {
        // 开启事务(关闭事务的自动提交,jdbc默认自动提交)
//            ConnectionUtils.geInstance().getCurrentThreadConn().setAutoCommit(false);
//            TransactionManager.getInstance().beginTransaction();
        Account from = accountDao.queryAccountByCardNo(fromCardNo);
        Account to = accountDao.queryAccountByCardNo(toCardNo);
        from.setMoney(from.getMoney() - money);
        to.setMoney(to.getMoney() + money);
        accountDao.updateAccountByCardNo(from);
        int c = 1 / 0;//人为异常
        accountDao.updateAccountByCardNo(to);
        // 提交事务
//            ConnectionUtils.geInstance().getCurrentThreadConn().commit();
        TransactionManager.getInstance().commit();
//        } catch (Exception e) {
//            e.printStackTrace();
//            // 回滚事务
////            ConnectionUtils.geInstance().getCurrentThreadConn().rollback();
//            TransactionManager.getInstance().rollback();
//            throw e; // 抛出异常,让servlet捕获
//        }
    }
}
```
#### TransferServlet(使用代理对象)
```java
package org.malred.edu.servlet; 
@WebServlet(name = "transferServlet", urlPatterns = "/transferServlet")
public class TransferServlet extends HttpServlet {
    // 1. 实例化service层对象
//    private TransferService transferService = new TransferServiceImpl();
//    private TransferService transferService =
//            (TransferService) BeanFactory.getBean("transferService");
    // 从工厂获取委托对象
    private TransferService transferService =
            (TransferService) ProxyFactory.getInstance()
                    .getJdkProxy(BeanFactory.getBean("transferService"));
//                    .getCglibProxy(BeanFactory.getBean("transferService"));

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp)
            throws ServletException, IOException {
        doPost(req, resp);
    }

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse
            resp) throws ServletException, IOException {
// 设置请求体的字符编码
        req.setCharacterEncoding("UTF-8");
        String fromCardNo = req.getParameter("fromCardNo");
        String toCardNo = req.getParameter("toCardNo");
        String moneyStr = req.getParameter("money");
        int money = Integer.parseInt(moneyStr);
        Result result = new Result();
        try {
// 2. 调⽤service层⽅法
            transferService.transfer(fromCardNo, toCardNo, money);
            result.setStatus("200");
        } catch (Exception e) {
            e.printStackTrace();
            result.setStatus("201");
            result.setMessage(e.toString());
        }
// 响应
        resp.setContentType("application/json;charset=utf-8");
        resp.getWriter().print(JsonUtils.object2Json(result));
    }
} 
```
## 改进,transactionManager和connectUtils有依赖关系,可以放到容器里,从工厂获取
![image.png](https://cdn.nlark.com/yuque/0/2022/png/26091703/1671781693845-4d9395bb-a2ca-4a62-9cc1-55f2b22c10d8.png#averageHue=%23faf8f7&clientId=ued658dc1-a871-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=700&id=u2d5b940c&margin=%5Bobject%20Object%5D&name=image.png&originHeight=875&originWidth=1408&originalType=binary&ratio=1&rotation=0&showTitle=false&size=325451&status=done&style=none&taskId=u0b256e9c-bfec-4630-9b62-b89d8222127&title=&width=1126.4)
### ConnectionUtils
```java
package org.malred.edu.utils; 
public class ConnectionUtils {
    // 工厂类来生成单例,这里不需要了
    // 保证当前类是单例,否则无法保证每次使用该类,其threadlocal都同一个
//    private ConnectionUtils() {
//    }
//
//    private static ConnectionUtils connectionUtils = new ConnectionUtils();
//
//    public static ConnectionUtils geInstance() {
//        return connectionUtils;
//    }

    /**
     * 总结而言：ThreadLocal是一个将在多线程中为每一个线程创建单独的变量副本的类;
     * 当使用ThreadLocal来维护变量时, ThreadLocal会为每个线程创建单独的变量副本,
     * 避免因多线程操作共享变量而导致的数据不一致的情况
     * ------
     * 著作权归@pdai所有
     * 原文链接：https://pdai.tech/md/java/thread/java-thread-x-threadlocal.html
     */
    // 存储当前线程的连接
    private static ThreadLocal<Connection> threadLocal = new ThreadLocal<>();

    /**
     * 从当前线程获取连接
     */
    public static Connection getCurrentThreadConn() throws SQLException {
        // 判断当前线程是否已经绑定连接,如果没有,就1,从连接池获取,2,并绑定到当前线程
        Connection connection = threadLocal.get();
        if (connection == null) {
            // 从连接池拿连接
            connection = DruidUtils.getInstance().getConnection();
            // 绑定到当前线程
            threadLocal.set(connection);
        }
        return connection;
    }
}
```
### JdbcAccountDaoImpl(提供set方法)
```java
package org.malred.edu.dao.impl; 
public class JdbcAccountDaoImpl implements AccountDao {
    private ConnectionUtils connectionUtils;

    // set方法,让工厂类可以依赖注入
    public void setConnectionUtils(ConnectionUtils connectionUtils) {
        this.connectionUtils = connectionUtils;
    }

    @Override
    public Account queryAccountByCardNo(String cardNo) throws Exception {
        //从连接池获取连接
        // Connection con = DruidUtils.getInstance().getConnection();
//        Connection con = ConnectionUtils.geInstance().getCurrentThreadConn();
        Connection con = connectionUtils.getCurrentThreadConn();
        String sql = "select * from account where cardNo=?";
        PreparedStatement preparedStatement = con.prepareStatement(sql);
        preparedStatement.setString(1, cardNo);
        ResultSet resultSet = preparedStatement.executeQuery();
        Account account = new Account();
        while (resultSet.next()) {
            account.setCardNo(resultSet.getString("cardNo"));
            account.setName(resultSet.getString("name"));
            account.setMoney(resultSet.getInt("money"));
        }
        resultSet.close();
        preparedStatement.close();
        // 不能关闭该连接,否则下次getCurrentThreadConn时会重新获取连接(因为上传的连接被销毁,判断为未绑定)
//        con.close();
        return account;
    }

    @Override
    public int updateAccountByCardNo(Account account) throws Exception {
        //从连接池获取连接
        // 改造为从当前线程中获取绑定的connect链接
//        Connection con = DruidUtils.getInstance().getConnection();
//        Connection con = ConnectionUtils.geInstance().getCurrentThreadConn();
        Connection con = connectionUtils.getCurrentThreadConn();
        String sql = "update account set money=? where cardNo=?";
        PreparedStatement preparedStatement = con.prepareStatement(sql);
        preparedStatement.setInt(1, (int) account.getMoney());
        preparedStatement.setString(2, account.getCardNo());
        int i = preparedStatement.executeUpdate();
        preparedStatement.close();
//        con.close(); // 不能关闭连接,因为当前线程已经绑定,关了就没有绑定了
        return i;
    }
}
```
### TransferServiceImpl(提供set方法)
```java
package org.malred.edu.service.impl; 
public class TransferServiceImpl implements TransferService {
    //    private AccountDao accountDao = new JdbcAccountDaoImpl();
//    private AccountDao accountDao = (AccountDao) BeanFactory.getBean("accountDao");
    // 更好的形式,让框架来注入属性
    private AccountDao accountDao;

    // 让框架可以反射设置值
    public void setAccountDao(AccountDao accountDao) {
        this.accountDao = accountDao;
    }

    private TransactionManager transactionManager;

    // 让框架可以反射设置值 
    public void setTransactionManager(TransactionManager transactionManager) {
        this.transactionManager = transactionManager;
    }

    @Override
    public void transfer(String fromCardNo, String toCardNo, int money) throws Exception {
//        try {
        // 开启事务(关闭事务的自动提交,jdbc默认自动提交)
//            ConnectionUtils.geInstance().getCurrentThreadConn().setAutoCommit(false);
//            TransactionManager.getInstance().beginTransaction();
        Account from = accountDao.queryAccountByCardNo(fromCardNo);
        Account to = accountDao.queryAccountByCardNo(toCardNo);
        from.setMoney(from.getMoney() - money);
        to.setMoney(to.getMoney() + money);
        accountDao.updateAccountByCardNo(from);
        int c = 1 / 0;//人为异常
        accountDao.updateAccountByCardNo(to);
        // 提交事务
//            ConnectionUtils.geInstance().getCurrentThreadConn().commit();
//        TransactionManager.getInstance().commit();
        transactionManager.commit();
//        } catch (Exception e) {
//            e.printStackTrace();
//            // 回滚事务
////            ConnectionUtils.geInstance().getCurrentThreadConn().rollback();
//            TransactionManager.getInstance().rollback();
//            throw e; // 抛出异常,让servlet捕获
//        }
    }
}
```
### TransactionManager(提供set方法)
```java
package org.malred.edu.utils; 
/**
 * 管理事务的类(开启/提交/回滚)
 */
public class TransactionManager {

    private ConnectionUtils connectionUtils;

    // set方法,让工厂类可以依赖注入
    public void setConnectionUtils(ConnectionUtils connectionUtils) {
        this.connectionUtils = connectionUtils;
    }
    // 工厂类来实例化单例
    // 也是单例
//    private static TransactionManager transactionManager = new TransactionManager();
//
//    public static TransactionManager getInstance() {
//        return transactionManager;
//    }

    // 开启手动事务控制
    public void beginTransaction() throws SQLException {
//        ConnectionUtils.geInstance().getCurrentThreadConn().setAutoCommit(false);
        connectionUtils.getCurrentThreadConn().setAutoCommit(false);
    }


    // 提交事务
    public void commit() throws SQLException {
//        ConnectionUtils.getCurrentThreadConn().commit();
        connectionUtils.getCurrentThreadConn().commit();
    }


    // 回滚事务
    public void rollback() throws SQLException {
//        ConnectionUtils.getCurrentThreadConn().rollback();
        connectionUtils.getCurrentThreadConn().rollback();
    }
} 
```
### ProxyFactory(提供set方法)
```java
package org.malred.edu.factory; 
/**
 * 工厂类: 统一返回代理类
 */
public class ProxyFactory {
    private TransactionManager transactionManager;

    public void setTransactionManager(TransactionManager transactionManager) {
        this.transactionManager = transactionManager;
    }
    // 工厂类来实例化单例
    // 单例
//    private static ProxyFactory instance = new ProxyFactory();
//
//    private ProxyFactory() {
//    }
//
//    public static ProxyFactory getInstance() {
//        return instance;
//    }

    /**
     * jdk动态代理
     *
     * @param obj 传入实现了接口的类
     */
    public Object getJdkProxy(Object obj) {
        // 获取代理对象
        return Proxy.newProxyInstance(obj.getClass().getClassLoader(), obj.getClass().getInterfaces(),
                new InvocationHandler() {
                    @Override
                    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
                        Object result = null;
                        try {
                            // 开启事务(关闭事务的自动提交,jdbc默认自动提交)
//                            TransactionManager.getInstance().beginTransaction();
                            transactionManager.beginTransaction();
                            // 调用原方法逻辑
                            result = method.invoke(obj, args);
                            // 提交事务
//                            TransactionManager.getInstance().commit();
                            transactionManager.commit();
                        } catch (Exception e) {
                            e.printStackTrace();
                            // 回滚事务
//                            TransactionManager.getInstance().rollback();
                            transactionManager.rollback();
                            throw e; // 抛出异常,让servlet捕获
                        }
                        return result;
                    }
                });
    }

    /**
     * cglib动态代理
     *
     * @param obj 类(不需要实现接口)
     * @return
     * @throws Exception
     */
    public Object getCglibProxy(Object obj) {
        return Enhancer.create(obj.getClass(), new MethodInterceptor() {
            @Override
            public Object intercept(Object o, Method method, Object[] objects, MethodProxy methodProxy) throws Throwable {
                Object result = null;
                try {
                    // 开启事务(关闭事务的自动提交,jdbc默认自动提交)
//                    TransactionManager.getInstance().beginTransaction();
                    transactionManager.beginTransaction();
                    // 调用原方法逻辑
                    result = method.invoke(obj, objects);
                    // 提交事务
//                    TransactionManager.getInstance().commit();
                    transactionManager.commit();
                } catch (Exception e) {
                    e.printStackTrace();
                    // 回滚事务
//                    TransactionManager.getInstance().rollback();
                    transactionManager.rollback();
                    throw e; // 抛出异常,让servlet捕获
                }
                return result;
            }
        });
    }
}
```
### TransferServlet
```java
package org.malred.edu.servlet; 
@WebServlet(name = "transferServlet", urlPatterns = "/transferServlet")
public class TransferServlet extends HttpServlet {
    // 1. 实例化service层对象
//    private TransferService transferService = new TransferServiceImpl();
//    private TransferService transferService =
//            (TransferService) BeanFactory.getBean("transferService");
    // 获取代理工厂类的实例对象
    private ProxyFactory proxyFactory = (ProxyFactory) BeanFactory.getBean("proxyFactory");
    // 从工厂获取委托对象
    private TransferService transferService =
            (TransferService) proxyFactory.getJdkProxy(BeanFactory.getBean("transferService"));
//            (TransferService) ProxyFactory.getInstance()
//                    .getCglibProxy(BeanFactory.getBean("transferService"));


    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp)
            throws ServletException, IOException {
        doPost(req, resp);
    }

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse
            resp) throws ServletException, IOException {
// 设置请求体的字符编码
        req.setCharacterEncoding("UTF-8");
        String fromCardNo = req.getParameter("fromCardNo");
        String toCardNo = req.getParameter("toCardNo");
        String moneyStr = req.getParameter("money");
        int money = Integer.parseInt(moneyStr);
        Result result = new Result();
        try {
// 2. 调⽤service层⽅法
            transferService.transfer(fromCardNo, toCardNo, money);
            result.setStatus("200");
        } catch (Exception e) {
            e.printStackTrace();
            result.setStatus("201");
            result.setMessage(e.toString());
        }
// 响应
        resp.setContentType("application/json;charset=utf-8");
        resp.getWriter().print(JsonUtils.object2Json(result));
    }
}
```
### beans.xml
```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!--跟标签beans，里面有很多的子标签bean，每一个bean子标签都代表一个类的配置-->
<beans>
    <!--通过class全类名来找到要框架来实例化的类-->
    <!--id作为外部获取bean的依据-->
    <bean id="accountDao" class="org.malred.edu.dao.impl.JdbcAccountDaoImpl">
        <property name="ConnectionUtils" ref="connectionUtils"></property>
    </bean>
    <bean id="transferService" class="org.malred.edu.service.impl.TransferServiceImpl">
        <!--通过添加标签来让框架帮忙注入属性,name是属性名,ref是对应的bean的id-->
        <!--通过set+name锁定set方法,通过反射来调用set方法传值-->
        <property name="AccountDao" ref="accountDao"></property>
        <property name="TransactionManager" ref="transactionManager"></property> 
    </bean>
    <bean id="connectionUtils" class="org.malred.edu.utils.ConnectionUtils"></bean>
    <bean id="transactionManager" class="org.malred.edu.utils.TransactionManager">
        <property name="ConnectionUtils" ref="connectionUtils"></property>
    </bean>
    <bean id="proxyFactory" class="org.malred.edu.factory.ProxyFactory">
        <property name="TransactionManager" ref="transactionManager"></property>
    </bean>
</beans>
```
